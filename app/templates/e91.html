{% extends "base.html" %}
{% block title %}Simulare E91 - QKD Explorer{% endblock %}

{% block content %}
<div class="card p-4">
    <h2 class="mb-3">Protocolul E91 (bazat pe Entanglement)</h2>
    <p>Protocolul E91 folosește perechi de qubiți în stare de inseparabilitate cuantică (entanglement), cum ar fi starea Bell. O sursă trimite câte un qubit din fiecare pereche către Alice și Bob. Corelațiile perfecte dintre măsurătorile lor (când folosesc aceleași baze) garantează securitatea cheii. Orice tentativă de spionaj ar distruge această corelație, ceea ce ar fi imediat detectabil.</p>
    
    <div class="mb-3">
        <button id="run-simulation" class="btn btn-primary">Rulează Demonstrație</button>
    </div>
    
    <div id="results-container">
        <div id="spinner" class="d-none text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="results-output"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.getElementById('run-simulation').addEventListener('click', async () => {
    const button = document.getElementById('run-simulation');
    const spinner = document.getElementById('spinner');
    const resultsOutput = document.getElementById('results-output');

    button.disabled = true;
    spinner.classList.remove('d-none');
    resultsOutput.innerHTML = '';

    try {
        const response = await fetch('/api/run_e91', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        let counts_labels = Object.keys(data.counts);
        let counts_values = Object.values(data.counts);

        resultsOutput.innerHTML = `
            <h5>Circuit Cuantic (Stare Bell + Măsurare)</h5>
            <pre class="bg-light p-3 rounded">${data.circuit}</pre>
            
            <h5>Rezultate Măsurători (1024 rulări)</h5>
            <div id="plot-div" style="width:100%; height:400px;"></div>
            <p class="mt-3 alert alert-info">${data.observation}</p>
        `;
        
        // Plot results
        const plotData = [{
            x: counts_labels,
            y: counts_values,
            type: 'bar',
            marker: {
                color: '#0d6efd'
            }
        }];
        const layout = {
            title: 'Distribuția Stărilor Măsurate',
            xaxis: {title: 'Stare Măsurată'},
            yaxis: {title: 'Număr apariții'}
        };
        Plotly.newPlot('plot-div', plotData, layout, {responsive: true});

    } catch (error) {
        resultsOutput.innerHTML = `<span class="text-danger">A apărut o eroare: ${error.message}</span>`;
    } finally {
        button.disabled = false;
        spinner.classList.add('d-none');
    }
});
</script>
{% endblock %}

